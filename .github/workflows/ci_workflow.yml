name: ci_workflow

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.10]
        poetry-version: [1.1.8]
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.poetry/bin" >> $GITHUB_PATH

      - name: Install project dependencies
        run: poetry install

      - name: Set up RabbitMQ
        run: |
          docker run -d --name rabbitmq-server \
            -p 5672:5672 -p 15672:15672 \
            -e RABBITMQ_DEFAULT_USER=appy \
            -e RABBITMQ_DEFAULT_PASS=ishigaki-urumasi \
            -e RABBITMQ_DEFAULT_VHOST=myMrsalHost \
            rabbitmq:3.9.21-management
          
          # Download and install the rabbitmq_delayed_message_exchange plugin
          docker exec rabbitmq-server sh -c "\
          curl -L https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/3.9.0/rabbitmq_delayed_message_exchange-3.9.0.ez > $RABBITMQ_HOME/plugins/rabbitmq_delayed_message_exchange-3.9.0.ez && \
          chown rabbitmq:rabbitmq $RABBITMQ_HOME/plugins/rabbitmq_delayed_message_exchange-3.9.0.ez && \
          rabbitmq-plugins enable rabbitmq_delayed_message_exchange \
          "
          
      - name: Wait for RabbitMQ to start
        run: |
          until docker exec rabbitmq-server rabbitmqctl list_queues -p myMrsalHost; do
            sleep 1
          done
  
      - name: Display RabbitMQ status
        run: docker exec rabbitmq-server rabbitmqctl status   

      - name: Run tests
        run: poetry run nox